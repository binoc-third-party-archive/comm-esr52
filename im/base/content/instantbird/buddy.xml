<?xml version="1.0"?>

<!DOCTYPE bindings>

<bindings id="buddyBindings"
          xmlns="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
          xmlns:xbl="http://www.mozilla.org/xbl">

  <binding id="buddy" extends="chrome://global/content/bindings/richlistbox.xml#richlistitem">
    <content>
      <xul:hbox>
	<xul:image xbl:inherits="src=icon" class="prplBuddyIcon"/>
	<xul:label xbl:inherits="value=displayname"/>
	<xul:textbox collapsed="true" class="plain" xbl:inherits="value=displayname"/>
      </xul:hbox>
    </content>
    <implementation>
     <constructor>
      <![CDATA[
       //dump("constructing buddy\n");
     ]]>
     </constructor>
     <destructor>
      <![CDATA[
       //dump("destructing buddy\n");
     ]]>
     </destructor>

     <method name="build">
      <parameter name="aBuddy"/>
      <body>
      <![CDATA[
        this.buddyId = aBuddy.id;
        this.name = aBuddy.name;
        this.alias = aBuddy.alias;
        this.setAttribute("displayname", this.alias || this.name);
        //this.setAttribute("id", "buddy" + this.buddyId);
        this.prpl = aBuddy.getAccount(0).protocol.id;
        this.setAttribute("icon", "chrome://instantbird/skin/prpl/" +
                                      this.prpl + ".png");
        this.accounts = { };
      ]]>
      </body>
     </method>

     <method name="addAccount">
      <parameter name="aPab"/>
      <body>
      <![CDATA[
        var id = aPab.account.id;
        if (id in this.accounts)
          throw "This buddy has already been added";
        this.accounts[id] = aPab;
      ]]>
      </body>
     </method>

     <method name="removeAccount">
      <parameter name="aPab"/>
      <body>
      <![CDATA[
        var id = aPab.account.id;
        if (!(id in this.accounts))
          throw "This buddy has not been added";

        delete this.accounts[id];

        if (this.accounts.__count__)
          return false;

        // No account left, this node is now useless, remove it
        this.parentNode.removeChild(this);
        return true;
      ]]>
      </body>
     </method>
    </implementation>
    <handlers>
     <handler event="click" clickcount="2">
       <![CDATA[
         var pcs = Components.classes["@instantbird.org/purple/core;1"]
                             .getService(Components.interfaces.purpleICoreService);
         var buddy = pcs.getBuddyById(this.buddyId);
         var conv;
         for (var id in this.accounts) {
           conv = this.accounts[id].createConversation();
           break;
         }

         var wm = Components.classes["@mozilla.org/appshell/window-mediator;1"]
                            .getService(Components.interfaces.nsIWindowMediator);
         var convWindow = wm.getMostRecentWindow("Messenger:convs");
         convWindow.msgObserver.focusConv(conv);
       ]]>
     </handler>
    </handlers>
  </binding>
</bindings>
